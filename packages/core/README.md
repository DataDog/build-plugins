# Datadog Build Plugins Core <!-- #omit in toc -->

A set of core functionalities to use within the Datadog Build Plugins ecosystem.

## Table of content <!-- #omit in toc -->

<!-- This is auto generated with yarn cli integrity -->

<!-- #toc -->
-   [Global Context](#global-context)
-   [Internal Plugins](#internal-plugins)
    -   [Build Report](#build-report)
    -   [Bundler Report](#bundler-report)
    -   [Git Plugins](#git-plugins)
    -   [Injection Plugin](#injection-plugin)
<!-- #toc -->

## Global Context

A global, shared context within the build plugins ecosystem.<br/>
It is passed at your plugin's initialization, and is mutated during the build process.

```typescript
type GlobalContext = {
    // Mirror of the user's config.
    auth?: {
        apiKey?: string;
    };
    // More details on the currently running bundler.
    bundler: {
        name: string;
        fullName: string; // Including its variant.
        outDir: string; // Output directory
        // Added in `buildStart`.
        rawConfig?: any;
        variant: string; // Major version of the bundler (webpack 4, webpack 5), empty string otherwise.
    };
    // Added in `writeBundle`.
    build: {
        errors: string[];
        warnings: string[];
        // The list of entries used in the build.
        entries ? : {
            filepath: string;
            inputs: Input[],
            name: string;
            outputs: Output[]
            size: number;
            type: string,
        } [];
        // The list of inputs used in the build.
        inputs ? : {
            filepath: string;
            dependencies: Input[];
            dependents: Input[]
            name: string;
            size: number;
            type: string,
        } [];
        // The list of outputs generated by the build.
        outputs ? : {
            filepath: string;
            name: string;
            size: number;
            type: string,
            // Sourcemaps will use Outputs as their Inputs.
            inputs: (Input | Output)[]
        } [];
        start?: number;
        end?: number;
        duration?: number;
        writeDuration?: number;
    };
    cwd: string;
    // Added in `buildStart`.
    git?: {
        hash: string;
        remote: string;
        trackedFilesMatcher: [TrackedFilesMatcher](packages/core/src/plugins/git/trackedFilesMatcher.ts);
    };
    inject: (item: { type: 'file' | 'code'; value: string; fallback?: @self }) => void;
    start: number;
    version: string;
}
```

> [!NOTE]
> Some parts of the context are only available after certain hooks:
>   - `context.bundler.rawConfig` is added in the `buildStart` hook.
>   - `context.build.*` is populated in the `writeBundle` hook.
>   - `context.git.*` is populated in the `buildStart` hook.

## Internal Plugins

We have a set of internal plugins that helps implementing customer facing plugins.<br/>
Most of them interacts via the Global Context.

### Build Report

This will populate `context.build` with a bunch of data coming from the build.

```typescript
{
    build: {
        errors: string[];
        warnings: string[];
        // The list of entries used in the build.
        entries ? : {
            filepath: string;
            inputs: Input[],
            name: string;
            outputs: Output[]
            size: number;
            type: string,
        } [];
        // The list of inputs used in the build.
        inputs ? : {
            filepath: string;
            dependencies: Input[];
            dependents: Input[]
            name: string;
            size: number;
            type: string,
        } [];
        // The list of outputs generated by the build.
        outputs ? : {
            filepath: string;
            name: string;
            size: number;
            type: string,
            // Sourcemaps will use Outputs as their Inputs.
            inputs: (Input | Output)[]
        } [];
        start?: number;
        end?: number;
        duration?: number;
        writeDuration?: number;
    };
}
```

### Bundler Report

A very basic report on the currently used bundler.<br/>
It is useful to unify some configurations.

```typescript
{
    bundler: {
        name: string;
        fullName: string; // Including its variant.
        outDir: string; // Output directory
        // Added in `buildStart`.
        rawConfig?: any;
        variant: string; // Major version of the bundler (webpack 4, webpack 5)
    };
}
```

### Git Plugins

Adds repository data to the global context from the `buildStart` hook.

```typescript
{
    // Added to the global context.
    git?: {
        hash: string;
        remote: string;
        trackedFilesMatcher: {
            matchSourcemap: (path: string, onSourceFound: (): void): string[];
            matchSources: (sources: string[]): string[];
            rawTrackedFilesList: (): string[];
        };
    }
}
```

> [!NOTE]
> This won't be added if `options.disabledGit = true` or `options.rum.sourcemaps.disabledGit = true`.

### Injection Plugin

This is used to prepend some code to the produced bundle.<br/>
Particularly useful if you want to share some global context, or to automatically inject some SDK.

It gives you access to the `context.inject()` function.

All the injections will be resolved during the `buildStart` hook,<br/>
so you'll have to have submitted your injection prior to that.<br/>
Ideally, you'd submit it during your plugin's initialization.

#### Distant file

You can give it a distant file.<br/>
Be mindful that a 5s timeout is enforced.

```typescript
context.inject({
    type: 'file',
    value: 'https://example.com/my_file.js',
});
```

#### Local file

You also give it a local file.<br/>
While you can use either a relative or absolute path, it's best to use an absolute one.<br/>
Remember that the plugins are also bundled before distribution.

```typescript
context.inject({
    type: 'file',
    value: path.resolve(__dirname, '../my_file.js'),
});
```

#### Raw code

Or give it any kind of string.<br/>
Be mindful that the code needs to be executable, or the plugins will crash.

```typescript
context.inject({
    type: 'code',
    value: 'console.log("My un-invasive code");',
});
```
